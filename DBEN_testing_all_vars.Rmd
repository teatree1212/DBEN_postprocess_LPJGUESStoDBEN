---
title: "DBEN_testing_all_vars"
author: "Annemarie Eckes-Shephard"
date: "2023-04-24"
output: pdf_document
---


## Summary:


Some models already have biomass at disturbance year (e.g. BiomeEP and BiomeES), while others have 0 values. We consider this a feature of the models and accept that some models therefore are on year 'ahead' in the dynamics.

For some models, some variables which have a value of 0 at disturbance year, but then have non-zero values for other variables. Please double-check. 
i.e. WBgrowth shows 0, but height is already at >0 values? That's of course plausible if height is initialised, but please clarify.

BiomeEP and BiomeES sometimes contain grasses in output that should be explicitly for wood. 
I can post-process the grasses 'away', but am wondering whether we in this case received output we asked for (i.e. WBgrowth). Please double-check. 
Ensheng answer: Woody PFTs only.

Some of the jitteryness comes from the climate forcing. We may create a 30-year running mean to smoothen this in the paper. Other jitteryness I would like to dicuss for individual outputs below (see my comments below).

From Amsterdam:
-still not really resolved for me:
How dependent is the disturbance recovery on how “disturbance/bare ground” was set up ? 

NA = no output provided. I mention in the individual model TODOs sent via mail, whether  an output is needed. For the rest, if you find you can easily add it, please go ahead for the next submission.

[TODOs for ANNEMARIE]
JULES-RED sizeclass <1 currently set to 0, but is actually "NA". Right now seems like there are 0 trees, instead of no output.
if(model_name =="JULES-RED"){
        df[,4] <- NULL
        
        
More Papers..:
Yet another interesting thing that could be compared in the future using this dataset (and community) is the way recruitment and establishment is represented in the different models. -> and then how seedling allometry is handeled.. ( i.e. are they just small trees or is allocation different? And does this matter?) Are they classified as grasses < threshold? what is the benefit/tradeoff of these representations?
Stem mortality is highest in the lower size-classes for all models, but it can drive up the stemmort count extensively in some models  i.e. two orders of magnitude differnet in total stemmortality for BiomeE-Standalone, if dbh<1 and <5 are considered or not. (probably justifiably so, since little seedlings <1 dbh are probably rather numerous on the forest floor..?)

        
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

# sampling of random numbers for forcing data:
set.seed(143)
1990+sample.int(30, 30)

#N-values extracted by running all 3 sites on simba, and for year 2015:
#         Lon      Lat    Year  NH4dep  NO3dep     fix    fert   input     min     imm  netmin   Total
#BIA    23.75    52.75    2015    4.84    5.23    2.35    0.00   12.42  212.05  121.51   90.54  102.96
#BCI   -79.75     9.25    2015    1.96    1.61   17.35    0.00   20.93  352.32  267.61   84.71  105.64
#FI1    23.25    62.25    2015    1.65    3.36    5.80    0.00   10.82  156.46  103.64   52.82   63.64
    
#4.84  +  5.23
#1.96  +  1.61 
#1.65  +  3.36 


```


```{r setup_functions}

source("DBEN_helper_functions.R")

#convenience function for grid.arrange
#passes back ggplot object for each model_output (input)
create_gobj <-function(model_out, y.lim = NULL,layers=NULL){
  p_out <- plotTemporal(model_out, legend.position = "none", layers=layers,title = model_out@source@name, y.lim )
  
return(p_out)
}


change_npp_unit <- function(var_to_plot){
   year_to_seconds = 31556952
          #convert to -yr:
          end <- dim(var_to_plot@data)[2]
          var_to_plot@data[,4:end] <- var_to_plot@data[,4:end] * year_to_seconds
          var_to_plot@quant@units <- "kgC m-2 yr-1"
          return(var_to_plot)
}
```

# Individual variables

Plotted for all model variables, in order of occurrence in the protocol table.
Sometimes I have questions to the model outputs. Please, everyone if you come across something fishy, point it out, and the people who know the models, please feel responsible in answering the questions.


### cveg

|Model |Comments|
|-------|-------|
|BiomeEP| |
|LPJ-GUESS| |
|FATES |AHES: Why is cveg not 0 at disturbance year?|
|BiomeES|AHES: Why is cveg not 0 at disturbance year? Ensheng: The vegetation is set to the initial settings, which have a bunch of seedlings fo all the PFTs.|
|JULES-RED|AHES: Why is cveg not 0 at disturbance year? Arthur: We remove 97.5% of the spun-up vegetation. It's not 0 as that is impossible for the model, we aren't able to spin-up if there is 0 veg frac or carbon.|


```{r testing_all_models_vars__cveg}

var  = "cveg"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)

```

### AGcwood

|Model |Comments|
|-------|-------|
|BiomeEP| |
|LPJ-GUESS| |
|FATES| |
|BiomeES| AHES: no AGcwood variable. Right now we are not comparing like-for-like here. What do we do for the paper: argue with low leaf carbon content ("The biomass of leaves is low, 0.2~0.4 kg C m-2.") or remove leaf fraction?|
|JULES-RED|AHES: Why does this not go to 0 at distyear? Arthur: See earlier comment about 97.5% removal.|

```{r testing_all_models_vars_AGcwood}

var  = "AGcwood"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

#AHES: AGB not AGcwood
BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = "AGB", file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

#AHES: AGB here AGcwood - note that the automated plotting will provide the wrong metadata for this plot. It is "Total Aboveground woody biomass"
JULESRED  <- get_output_JULESRED(site,run ="1",var = "AGB",file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```

## cwood

|Model |Comments|
|-------|-------|
|BiomeEP| |
|LPJ-GUESS| |
|FATES |AHES: Why does this not go to 0 at distyear?|
|BiomeES|AHES: cwood goes to 0, so in other plots i.e. cveg the non-0 amount is indeed  cause by the grass fraction ( makes sense to me). Ensheng: It should have a very small amount of cwood if the trees are still there. 17.07.2023: checked this, and yes, cwood is never 0. lowest value 0.034155|
|JULES-RED|AHES: Why does this not go to 0 at distyear? Arthur: Again see first comment.|

```{r testing_all_models_vars_cwood}

var  = "cwood"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)


JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = "cwood",file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```


## cwood_size

```{r testing_all_models_vars_cwood_size}

var  = "cwood_size"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)


JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```

## nstem_size

```{r testing_all_models_vars_nstem_size}

var  = "nstem_size"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)


JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)

```

## lai 

|Model |Comments|
|-------|-------|
|BiomeEP| |
|LPJ-GUESS| |
|FATES | Why is LAI never 0?|
|BiomeES| Why is LAI never 0?  Grass fraction? Ensheng: Evergreen PFTs or initial seedlings at the year of disturbance.|
|JULES-RED|Why is LAI never 0? Arthur: We always have PFT tiles present within a gridbox, it will not go to zero. Mean LAI is calculated as the weighted average sizeclass LAI with respect to projected crown area or fraction for each class. |
|CABLE-POP |Why is LAI never 0?|

```{r testing_all_models_vars_lai}

var  = "lai"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```


##Crown Area --- Projected crown area or PFT /multi canopy crown area ?

*Issue with Crown area variable definition*

How to standardise amongst models? 
What do we want to compare against? 
I would say satellite observations? Is Crownarea otherwise comparable against any other observations? Maybe some LIDAR observations?


Ensheng: In BiomeE, crown area is a structural variable, indicating the lateral expansion of tree branches. It is a key variable for space (and light) competition. We could use LIDAR and also FIA data have the information of crown expansions.

|Model |Comments|
|-------|-------|
|JULES-RED| projected crown area? Arthur: Projected crown area, equivalent to gridbox fraction until canopy closure.|
|LPJ-GUESS| projected crown area?|
|BiomeEP| multi-canopy structure /multi LAI based?|
|BiomeES| multi-canopy structure /multi LAI based? Ensheng: Here, the crown area is the sum of all plants.|
|FATES| multi-canopy structure /multi LAI based?|
|CABLE-POP| projected crown area?|


```{r testing_all_models_vars_CA}

var  = "CA"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

#pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
#pEDv3 <- create_gobj(pEDv3)
#18.07.2023 no crown area submitted

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pSEIBDGVM)
```


## BA

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: Grasses shouldn't have basal area output.|
|LPJ-GUESS|     |
|FATES |AHES: BA output missing|
|BiomeES |      |
|JULES-RED|     |
|CABLE-POP|     |

```{r testing_all_models_vars_BA}

var  = "BA"
site ="FIN"
run ="P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

#FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
#plotTemporal(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP  <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```


## height
[TODO] for height - remove "Total" column, instead plot max, but dotted
Height output ambiguous between models. So the y-axis here is misleading and I cannot fully interpret it.
Reported in Protocol: "95 th percentile of tree height"

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: height never goes to 0.|
|LPJ-GUESS| |
|FATES | AHES: no height output. Jessica "We don't have 95th percentile of height in FATES. I can do crown area weighted height if useful?"|
|BiomeES|AHES: v. jittery. Why?AHES: height never goes to 0. Ensheng: yes, all plants start from a "seedling" and the stage of "seeds" was skipped.|
|JULES-RED|AHES: height never goes to 0. Arthur: As number density never goes towards zero, the 95th percentile height never goes towards zero.|
|CABLE-POP|AHES: height never goes to 0.|

```{r testing_all_models_vars_height}

var  = "height"
site = "FIN"
run  = "P0"
BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)
min(BiomeEP@data$Total)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)
# height output confirmed: mean PFT height in 95th percentile.

#FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
#plotTemporal(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)
min(BiomeES@data$Total)
# height confirmed: "95 th percentile of tree height"

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pCABLEPOP <- create_gobj(JULESRED)

CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)

```

## roughness - optional output
The two models which provide this output currently have two orders of magnitude difference in their values.

|Model |Comments|
|-------|-------|
|BiomeEP| NA|
|LPJ-GUESS|NA|
|FATES |AHES: Does show any dynamics in keeping with regrowth dynamics. why?|
|BiomeES| NA|
|JULES-RED| |
|CABLE-POP| NA|


```{r testing_all_models_vars_roughness}

var  = "z0"
site ="FIN"
run ="P0"
#BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
#plotTemporal(BiomeEP)

#LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
#plotTemporal(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
pFATES <- create_gobj(FATES)

#BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
#plotTemporal(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

#CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
#pCABLEPOP <- create_gobj(CABLEPOP)


grid.arrange(pJULESRED,pFATES)
```

## albedo - optional output

|Model |Comments|
|-------|-------|
|BiomeEP|NA     |
|LPJ-GUESS|AHES: NA[TODO] get this from post processing still..|
|FATES | AHES: Does show any dynamics in keeping with regrowth dynamics. why?|
|BiomeES|NA|
|JULES-RED| |
|CABLE-POP| AHES: no trace of regrowth, but in the same bulpark as JULES-RED when in equilibrium. Juergen Knauer in email: drop this variable. AHES: but maybe easy to fix?|


```{r testing_all_models_vars_albedo}

var  = "albedo"
site ="FIN"
run ="P0"

#BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
#plotTemporal(BiomeEP)

#LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
#plotTemporal(LPJGUESS)

#FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name ="FATES")
#plotTemporal(FATES)

#BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
#plotTemporal(BiomeES)

JULESRED <- get_output_JULESRED(site,run ="1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)


CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


grid.arrange(pJULESRED,pCABLEPOP)
```


## WBgrowth

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: remove grasses. double-check the output is indeed woody biomass only, not something like cveg or another carbon pool.17.07 AHES removed grasses from plot|
| LPJ-GUESS|AHES: not gross growth?!|
|FATES |AHES: never goes to 0.|
| BiomeES|AHES: remove grasses. double-check the output is indeed woody biomass only, not something like cveg or another carbon pool. Ensheng: specific variables include all PFTs, though for some of them grasses are not required, such as BAgrowth, cwood, cveg. It is not easy to exclude grass PFTs specifically in generating netcdf files. I suggest not including grass PFTs when plotting. AHES 17.07: done|
|JULES-RED|AHES: remove grasses. double-check the output is indeed woody biomass only, not something like cveg or another carbon pool.
AHES: why no BINE PFT in FIN? Arthur: that's nature of competition ( only at establishment ) in the model|
|CABLE-POP|AHES: WBgrowth rate not much influenced by regrowth-dynamics.AHES: add PFT dimension easily possible? (not to worry for this analysis?)|

```{r testing_all_models_vars_WBgrowth}

var  = "WBgrowth"
site ="FIN" # note, cannot easily change site here, because I am subsetting for  site- specific PFTs for BiomeES to omit grasses in this plot.

run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
#updated total without grasses:
BiomeEP@data$Total <- rowSums(BiomeEP@data[,-c("Year","Lat","Lon","Grasses","Total")])
pBiomeEP <- create_gobj(BiomeEP,layers=c("BINE","NE","IBS","Total"))

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
#updated total without grasses:
BiomeEP@data$Total <- rowSums(BiomeEP@data[,-c("Year","Lat","Lon","Grasses","Total")])
pBiomeES <- create_gobj(BiomeES,layers=c("BINE","NE","IBS","Total"))

JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)

#[TODO] 06.06.2023 CABLE POP WBgrowth output now does not work in version_2. I think Juergen added pfts, so the dimensions may have changed.
#17.07.2023 solved
CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)
```

## BAgrowth

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: remove grasses. double-check the output is BAgrowth, not something like cveg or another carbon pool. Units are also v.high.|
|LPJ-GUESS|AHES: maybe not gross growth?|
|FATES |17.07.2023: there is a file called "Bgrowth" is this basal area growth? add PFT dimension easily possible? (not to worry for this analysis?)|
|BiomeES|AHES: remove grasses. double-check the output is indeed woody biomass only, not something like cveg or another carbon pool. Ensheng: specific variables include all PFTs, though for some of them grasses are not required, such as BAgrowth, cwood, cveg. It is not easy to exclude grass PFTs specifically in generating netcdf files. I suggest not including grass PFTs when plotting.|
|JULES-RED|AHES: negative basal area growth. 18.07.2023 resolved in v2(plotted here)|
|CABLE-POP|AHES: add PFT dimension easily possible? (not to worry for this analysis?) 18.08.2023: PFT-dimension added in v2(plotted here)|
|EDv3 | AHES 18.07.2023: negative basal area growth. we want gross growth|
|SEIB | NA|

```{r testing_all_models_vars_BAgrowth}

var  = "BAgrowth"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

#only total provided:
FATES <- get_output_FATES(site,run,var="Bgrowth",file.dir=file.dir.fates,model_name = "FATES")
plotTemporal(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

#pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
#pSEIBDGVM <- create_gobj(pSEIBDGVM) 18.07.2023 BAgrowth output not submitted

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3)

```


## cmort
BiomeEP, BiomeE and Jules-RED seem to reset to bare ground as a mechanism to introduce disturbance. The rest of the models kills all trees. That way, the mortality flux at the disturbance event is recorded in the output.

|Model |Comments|
|-------|-------|
|BiomeEP| |
|LPJ-GUESS| |
|FATES | |
|BiomeES| | EW in email: "By the way, the up and downs of the size class curve is due to wide bins for merging similar sized cohorts in the model, while the plotting bins are small. I halved the bin width in this model run. Small bins lead to more cohorts and thus slow down model run."|
|JULES-RED| |
|CABLE-POP|Added all mortalities together.|
|EDv3 | |
|SEIB | |


```{r testing_all_models_vars_cmort}

var  = "cmort"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = "cmort_size",file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = "cmort_size", file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

#cmort_disb + cmort_mort
pEDv3  <- get_model_output(site,run = run,var = var,model_name ="EDv3",co2_levels = "412ppm")
pEDv3  <- create_gobj(pEDv3)

#cmort_res+ cmort_dist + cmort_crowd
CABLEPOP <- get_model_output(site,run = run,var = var,model_name ="CABLE-POP",co2_levels = "412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)

```



## is the budget closed? 

woody growth_rate - mort_rate = 0 ( in equilibrium)

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: too low. One possibility - are the grasses included in the cmort output ? 18.07.2023: v2 has same low-bias.|
|LPJ-GUESS|AHES: show age mortality (=decline to negative),"Equilibrium" probably maybe more dynamic than other models. OK confirmed with TOM . |
|FATES |AHES: too high. now too low in v2 (18.07.2023) [TODO] check grasses are not counted in mortality rate|
|BiomeES| |
|JULES-RED| Too high in equilibrium, Arthur: Probably something we're not calculating in the above formula (leaf pool). Might also be related to recruitment carbon flux. I'll have a look in the post processing and get back to you.. AHES: also in v2 (18.07.2023)|
|CABLE-POP| Too low. or is this "OK " for CABLE-POP? To me there seems to be a bias, that needs to be adressed. Juergen 23.05.2023: all rates should be included. [TODO] check grasses are not included in mortality rate? |
|EDv3 | |
|SEIB | AHES: potentially re-solved when stochasticity is reduced? But seems to have low-bias, especially prevalent in the tropics|

```{r testing_all_models_vars_testing_budget}
par(mfrow =c(3,3),oma=c(1,2,1,1),mar=c(1,1,1,1))


run  = "P0"
for(site in c("FIN","BIA","BCI")){
    var  = "cmort"
    
    BiomeEP_cmort <- get_output_BiomeEP(site,run,var = "cmort_size",file.dir = file.dir.biomeEP,co2_levels = "412ppm")
    
    LPJGUESS_cmort <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
    
    FATES_cmort <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
    
    BiomeES_cmort <- get_output_BiomeE_standalone(site,run = "00",var = "cmort_size", file.dir.biomeE_Standalone,co2_levels = "412ppm")
    
    JULESRED_cmort <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
    
    #cmort_disb + cmort_mort
    EDv3_cmort  <- get_model_output(site,run = run,var = var,model_name ="EDv3",co2_levels = "412ppm")
    #EDv3_cmort_nodist  <- get_output_EDv3(site,run = run,var = "cmort_mort",file.dir=file.dir.EDv3,co2_levels = "412ppm")
    
    #cmort_res + cmort_crowd + cmort_dist
    CABLEPOP_cmort <- get_model_output(site,run = run,var = var,model_name ="CABLE-POP",co2_levels = "412ppm")
    
    #cmort_res + cmort_crowd
    CABLEPOP_crowd <- get_output_CABLEPOP(site,run = "0",file.dir=file.dir.cablepop,var = "cmort_crowd",co2_levels = "PS_412ppm")
    CABLEPOP_res   <- get_output_CABLEPOP(site,run = "0",file.dir=file.dir.cablepop,var = "cmort_res",co2_levels = "PS_412ppm")
    CABLEPOP_cmort_nodist <- CABLEPOP_res@data$Total + CABLEPOP_crowd@data$Total
    
    SEIBDGVM_cmort  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
    
    
    #######################
    ##wbgrowth
    var  = "WBgrowth"
    BiomeEP_WBgrowth <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
    #plotTemporal(BiomeEP_WBgrowth)
    
    LPJGUESS_WBgrowth <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
    
    FATES_WBgrowth <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
    
    BiomeES_WBgrowth <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
    
    JULESRED_WBgrowth <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
    
    CABLEPOP_WBgrowth <- get_output_CABLEPOP(site,run = "0",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
    
    SEIBDGVM_WBgrowth  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
    
    EDv3_WBgrowth  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
    
    
    #################################
    ##AGcwood
    var ="AGcwood"
    BiomeEP_AGcwood <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
    
    LPJGUESS_AGcwood <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
    #plotTemporal(LPJGUESS_AGcwood)
    
    FATES_AGcwood <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
    
    BiomeES_AGcwood <- get_output_BiomeE_standalone(site,run = "00",var = "AGB", file.dir.biomeE_Standalone,co2_levels = "412ppm")
    
    
    JULESRED_AGcwood <- get_output_JULESRED(site,run = "1",var = "AGB",file.dir.julesred,co2_levels = "412ppm")
    
    CABLEPOP_AGcwood <- get_output_CABLEPOP(site,run = "0",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
    
    SEIBDGVM_AGcwood  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
    
    EDv3_AGcwood  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
    
    ##########################################################################
    
    plot(LPJGUESS_WBgrowth@data$Total -  LPJGUESS_cmort@data$Total, type="l",main = "LPJGUESS",ylim=c(-2,1))
    #woody growth - woody biomass*mort_rate = 0
    
    plot(JULESRED_WBgrowth@data$Total - JULESRED_cmort@data$Total, type="l",main ="JULESRED")
    #solved
    
    plot(FATES_WBgrowth@data$Total    -  FATES_cmort@data$Total, type="l",ylim= c(-1,2),main ="FATES")
    
    plot(BiomeES_WBgrowth@data$Total  -  BiomeES_cmort@data$Total, type="l",ylim= c(-5,0.5),main ="BiomeES")
    
    plot(BiomeEP_WBgrowth@data$Total  - BiomeEP_cmort@data$Total, type="l",ylim= c(-5,0.5),main = "BiomeEP")
    #Grasses?
    abline(h=0,col="grey")
    
    plot(EDv3_WBgrowth@data$Total     - EDv3_cmort@data$Total , type="l",ylim= c(-5,0.5),main = "EDv3")
    abline(h=0,col="grey")
    #plot(EDv3_WBgrowth@data$Total      - EDv3_cmort_nodist@data$Total , type="l",ylim= c(-5,0.5),main = "EDv3")
    #abline(h=0,col="grey")
    
    plot(SEIBDGVM_WBgrowth@data$Total - SEIBDGVM_cmort@data$Total , type="l",ylim= c(-5,0.5),main = "SEIB-DGVM")
    mean(SEIBDGVM_WBgrowth@data$Total[400:450]) - mean(SEIBDGVM_cmort@data$Total[400:450])
    
    plot(CABLEPOP_WBgrowth@data$Total - CABLEPOP_cmort@data$Total, type="l",ylim= c(-5,0.5),main = "CABLEPOP  with disturbance")
    
    abline(h=0,col="grey")
    plot(CABLEPOP_WBgrowth@data$Total - CABLEPOP_cmort_nodist, type="l",ylim= c(-5,0.5),main = "CABLEPOP")
    abline(h=0,col="grey")
    
    mtext(outer=TRUE ,"KgC /yr",side =2,line = 0.8)
    # nb:grasses included for BiomeES and BiomeEP in some outputs.
}


run  = "P0"
for(site in c("FIN","BIA","BCI")){
    var  = "cmort"
    
     JULESRED_cmort <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
     
     var="WBgrowth"
    JULESRED_WBgrowth <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
   
     
 plot(JULESRED_WBgrowth@data$Total - JULESRED_cmort@data$Total, type="l",main =paste ("JULESRED",site))
    #solved
}

```


## stemmort

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: Unit low: should be Count ha-1yr-1. *nstems[y-1] ? AHES 18.07.2023: converted to ha-1, Beni, Laura: please confirm.Now very high.|
|LPJ-GUESS| |
|BiomeES|AHES: Unit low: should be Count ha-1yr-1. *nstems[y-1] ?Why so jittery? Biology model structure or post-processing? Ensheng: The unit of "Stemmort" is n_stems per year per m2. AHES 18.07.2023: converted to ha-1. Now very high.|
|JULES-RED|AHES: what causes the small oscillations on top of the general number flux dynamics? Arthur: Seems to be applied across all size classes, just larger at the largest  mass classes.  It is probably related to oscillation in the growth rates.|
|CABLE-POP| NA|
|EDv3| AHES: Interesting we don't see a 0 stem mortality at the beginning of establishment. Is there a seedling mortality or something like that? or is there thinning going on right away?|
|SEIB| very low numbers. please check unit: DBEN-unit: Count ha-1yr-1|

FATES-  AHES: output year 1: stem number flux almost 0 AHES: strange oscillations in _overstory.nc, due to PFT2 (e.g. simyear 32)

|  Year|  Lat  | Lon  | <1    |  <5       |  <10      |    <15    |     <20|
|-----|--------|------|-------|-----------|-----------|-----------|-----------| 
|  32 | 62.25 | 23.25 | 0  |1678.8756  | 572.7487876 |164.84464856 |88.34444358|
 
these numbers are also present in the .netcdf file, so not a read-in error.
or is this just a quick transition of trees from under- to over-story after the disturbance?
But I what is this oscillation exactly?   

```{r testing_all_models_vars_stemmort}

var  = "stemmort"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = "stemmort_size",file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP_allsc  <- create_gobj(BiomeEP)
#updated total without sizeclasses "<1","<5":
#update name for plotting, to distinguish between subest and all size- classes:
BiomeEP@source@name <- paste( BiomeEP@source@name,"no sclass <1 <5")
BiomeEP@data$Total <- rowSums(BiomeEP@data[,-c("Year","Lat","Lon","<1","<5","Total")]) 
pBiomeEP           <- create_gobj(BiomeEP,layers=c(sc[-c(1,2)],c("Total")))


LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = "stemmort_size", file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES_allsc  <- create_gobj(BiomeES)
#updated total without sizeclasses "<1","<5":
#update name for plotting, to distinguish between subest and all size- classes:
BiomeES@source@name <- paste( BiomeES@source@name,"no sclass <1 <5")
BiomeES@data$Total <- rowSums(BiomeES@data[,-c("Year","Lat","Lon","<1","<5","Total")]) 
pBiomeES           <- create_gobj(BiomeES,layers=c(sc[-c(1,2)],c("Total")))


JULESRED  <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

#CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
#plotTemporal(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

EDv3  <- get_model_output(site,run = run,var = var,model_name ="EDv3",co2_levels = "412ppm")
pEDv3_allsc  <- create_gobj(EDv3)
#updated total without sizeclasses "<1","<5":
#update name for plotting, to distinguish between subest and all size- classes:
EDv3@source@name <- paste( EDv3@source@name,"no sclass <1 <5")
EDv3@data$Total <- rowSums(EDv3@data[,-c("Year","Lat","Lon","<1","<5","Total")]) 
pEDv3          <- create_gobj(EDv3,layers=c(sc[-c(1,2)],c("Total")))


grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pEDv3,pSEIBDGVM)


grid.arrange(pBiomeEP_allsc,pBiomeES_allsc,pEDv3_allsc)
```

## gpp

|Model |Comments|
|-------|-------|
|BiomeEP|AHES: netcdf only 0 values for gpp for BCI - double check output|
|LPJ-GUESS| 17.07.2023 AHES unit issue will solve itself after next iteration.|
|FATES |    |
|BiomeES|   |
|JULES-RED| AHES:FIN:  only PFT2 really active. PFT1 never present? Arthur: nature of competition in model.|
|CABLE-POP|  |
|EDv3|  |
|SEIB| AHES PFT missing in gpp. Grasses?  |

```{r gpp}
var  = "gpp"
site ="BCI"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)

```

## npp

|Model |Comments|
|-------|-------|
|BiomeEP|     |
|LPJ-GUESS|     |
|FATES |AHES: simulation output year 1 negative|
|BiomeES|    |
|JULES-RED|AHES:FIN:  only PFT2 really active. PFT1 never present?|
|EDv3|  |
|SEIB| AHES PFT missing in npp. Grasses?  |


```{r npp}
var  = "npp"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
pJULESRED <- create_gobj(JULESRED)

CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)


pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pJULESRED,pCABLEPOP,pEDv3,pSEIBDGVM)


```

## nbp
From the protocol: "Positive flux is into the land."

post-disturbance, there is a less positive flux into the land for FATES


|Model |Comments|
|-------|-------|
|BiomeEP||
|LPJ-GUESS|AHES: dynamics post disturbance look a bit odd.. double-check output; does soil C increase?|
|FATES |AHES: Seems to me in terms of NBP, FATES is not yet(?) in equilibrium. Seems to always take up more than it releases. different to other models or overaccounting of output? First output value needs double-checking.|
|BiomeES| |
|JULES-RED|NA|
|CABLE-POP| |
|EDv3|  |
|SEIB|  |


```{r nbp}
var  = "nbp"
site ="FIN"
run ="P0"

BiomeEP <- get_output_BiomeEP(site,run,var = var,file.dir = file.dir.biomeEP,co2_levels = "412ppm")
pBiomeEP <- create_gobj(BiomeEP)

LPJGUESS <- get_output_LPJGUESS(site,run,var,file.dir = file.dir.lpjguess,co2_levels = "PS_412ppm/")
pLPJGUESS <- create_gobj(LPJGUESS)

FATES <- get_output_FATES(site,run,var,file.dir=file.dir.fates,model_name = "FATES")
pFATES <- create_gobj(FATES)

BiomeES <- get_output_BiomeE_standalone(site,run = "00",var = var, file.dir.biomeE_Standalone,co2_levels = "412ppm")
pBiomeES <- create_gobj(BiomeES)

#17.07.2023:
#JULESRED <- get_output_JULESRED(site,run = "1",var = var,file.dir.julesred,co2_levels = "412ppm")
#plotTemporal(JULESRED)

CABLEPOP <- get_output_CABLEPOP(site,run = "1",var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
pCABLEPOP <- create_gobj(CABLEPOP)

pSEIBDGVM  <- get_output_SEIBDGVM(site,run = run,var = var,file.dir.seibdgvm,co2_levels = "412ppm")
pSEIBDGVM <- create_gobj(pSEIBDGVM)

pEDv3  <- get_output_EDv3(site,run = run,var = var,file.dir.EDv3,co2_levels = "412ppm")
pEDv3 <- create_gobj(pEDv3)

grid.arrange(pBiomeEP,pLPJGUESS,pFATES,pBiomeES,pCABLEPOP,pEDv3,pSEIBDGVM)

```





#testing cveg for disturbance runs 
- did the models spin up with these disturbance settings, too? That would obviously. make a bit difference..


#time it takes to reach 75% of the biomass at equilibrium

```{r testing_all_models_vars_cveg, eval=FALSE}

var  = "cveg"
site = "FIN"
run  = "P1"

#to deal with different file naming conventions:
runs = c("P1","P2","P3","P4","P5","P6","P7")
runs_biomeEP <- c("P0","PS1","PS2","PS3","PS4","PS5","PS6")

#Disturbance: stand-replacing (resetting to initial conditions) and stochastic with mean frequency
#of:0.01, 0.02, 0.04, 0.08, 0.20, 0.40 (corresponding to the file names: _01, _02, _04, _08, _20, _40)
runs_biomeES <- c("00","01", "02", "04", "08", "20", "40")
runs_julesred = c("1","2","3","4","5","6","6")
runs_cablepop = c("1","2","3","4","5","6","7")
#[TODO] re-naming of biomeEP scenarios once PS1 is run.


collect  <- data.frame(FIN = rep(NA,length(runs)),BIA = rep(NA,length(runs)),BCI = rep(NA,length(runs)), model_name =c(rep(c("LPJ-GUESS","BiomeEP","BiomeE-Standalone" ,"JULES-RED","CABLE-POP","FATES"),each=length(runs))))

year_end=450

for (i in 1:length(runs)){
#r=7
    
  for (site in c("FIN","BIA","BCI")){
  LPJG_FI <- get_output_LPJGUESS(site, runs[i], var = var, file.dir = file.dir.lpjguess,co2_levels = "PS_562ppm")
  BiomeEP_FI <- get_output_BiomeEP(site,run = runs_biomeEP[i],var = var,file.dir = file.dir.biomeEP,co2_levels = "562ppm")
  #[TODO] double-check what AGB -output is in BiomeE-standalone
  BiomeES_FI <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "562ppm")
  # AGB is woody biomass only ( confirmed with AA 02.04.2023) 
  if(i<=6){
  JULESRED <- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "562ppm")
  }
  CABLEPOP <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_562ppm")
  FATES <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")

  #take only the last year, assuming that is the equilibrium. for those models that ran at plot-scale, take the average across 400 - 800 simulation years.
  collect[which(collect$model_name =="LPJ-GUESS"),site][[i]] <-  LPJG_FI@data[which(LPJG_FI@data$Year == year_end),]$Total
  #use an average of the last 400 years from these simulations to approximate landscale-level (conversation with Ensheng Weng), 
  #relevant paper that proves time-averaging is the same as space averaging:  https://agupubs-onlinelibrary-wiley-com.ludwig.lub.lu.se/doi/full/10.1029/2012JG002040
  collect[which(collect$model_name =="BiomeEP"),site][[i]] <-            mean(BiomeEP_FI@data[60:450,]$Total)
  collect[which(collect$model_name =="BiomeE-Standalone"),site][[i]] <-  mean(BiomeES_FI@data[60:810,]$Total)
  if(i<=6){ # only 6 simulations at the moment:
  collect[which(collect$model_name =="JULES-RED"),site][[i]] <-  JULESRED@data[which(JULESRED@data$Year == year_end),]$Total
  }
  collect[which(collect$model_name =="CABLE-POP"),site][[i]] <-  CABLEPOP@data[which(CABLEPOP@data$Year == year_end-1),]$Total
  collect[which(collect$model_name =="FATES"),site][[i]] <-  mean(FATES@data[which(FATES@data$Year  >= year_end-30),]$Total) 
  }
}
perc_75 <- collect
perc_75[,1:3] <- collect[,1:3]*0.75

#time it takes to get >75%

period_length <- data.frame(FIN = rep(NA,length(runs)),BIA = rep(NA,length(runs)),BCI = rep(NA,length(runs)), model_name =c(rep(c("LPJ-GUESS","BiomeEP","BiomeE-Standalone" ,"JULES-RED","CABLE-POP","FATES"),each=length(runs))))


collect_ambient <- collect #<- [which(collect$model_name =="LPJ-GUESS"),site][[i]]

for (i in 1:length(runs)){
#r=7
    
  for (site in c("FIN","BIA","BCI")){
  LPJG_FI <- get_output_LPJGUESS(site, runs[i], var = var, file.dir = file.dir.lpjguess,co2_levels = "PS_562ppm")
  BiomeEP_FI <- get_output_BiomeEP(site,run = runs_biomeEP[i],var = var,file.dir = file.dir.biomeEP,co2_levels = "562ppm")
  #[TODO] double-check what AGB -output is in BiomeE-standalone
  BiomeES_FI <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "562ppm")
  # AGB is woody biomass only ( confirmed with AA 02.04.2023) 
  if(i<=6){
  JULESRED <- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "562ppm")
  }
  CABLEPOP <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_562ppm")
  FATES <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")

  #take only the last year, assuming that is the equilibrium. for those models that ran at plot-scale, take the average across 400 - 800 simulation years.
  
 LPJG_FI <-  as.data.frame(LPJG_FI)
 BiomeEP_FI <- as.data.frame(BiomeEP_FI)
 BiomeES_FI <- as.data.frame(BiomeES_FI)
 JULESRED <- as.data.frame(JULESRED)
 CABLEPOP <- as.data.frame(CABLEPOP)
 FATES <- as.data.frame(FATES)
 
  collect_ambient[which(collect_ambient$model_name =="LPJ-GUESS"),site][[i]] <-  LPJG_FI[which(LPJG_FI$Total> perc_75[which(perc_75$model_name =="LPJ-GUESS"),site][i]),]$Year[1]
  #use an average of the last 400 years from these simulations to approximate landscale-level (conversation with Ensheng Weng), 
  #relevant paper that proves time-averaging is the same as space averaging:  https://agupubs-onlinelibrary-wiley-com.ludwig.lub.lu.se/doi/full/10.1029/2012JG002040
  collect_ambient[which(collect_ambient$model_name =="BiomeEP"),site][[i]] <-            BiomeEP_FI[which(BiomeEP_FI$Total> perc_75[which(perc_75$model_name =="BiomeEP"),site][[i]]),]$Year[1]
  
  collect_ambient[which(collect_ambient$model_name =="BiomeE-Standalone"),site][[i]] <- 
    BiomeES_FI[which(BiomeES_FI$Total> perc_75[which(perc_75$model_name =="BiomeE-Standalone"),site][[i]]),]$Year[1]
    
  
  if(i<=6){ # only 6 simulations at the moment:
  collect_ambient[which(collect_ambient$model_name =="JULES-RED"),site][[i]] <-  
      JULESRED[which(JULESRED$Total> perc_75[which(perc_75$model_name =="JULES-RED"),site][[i]]),]$Year[1]
  }
  
  collect_ambient[which(collect_ambient$model_name =="CABLE-POP"),site][[i]] <- 
     CABLEPOP[which(CABLEPOP$Total> perc_75[which(perc_75$model_name =="CABLE-POP"),site][[i]]),]$Year[1]

    
    
  collect_ambient[which(collect_ambient$model_name =="FATES"),site][[i]] <- 
     FATES[which(FATES$Total> perc_75[which(perc_75$model_name =="FATES"),site][[i]]),]$Year[1]
  }
}



par(mfrow=c(2,2))
site="BIA"
for (i in 1:length(runs)){
#r=7
    var="cveg"
  #for (site in c("FIN","BIA","BCI")){
  
  FATES_e <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")
  FATES_a <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total,lty=2, type="l",xlim=c(30,60),main="FATES", col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }else{
    lines(FATES_e@data$Year,FATES_e@data$Total,lty=2, col =i)
       lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
    
}

par(mfcol=c(3,2))
sites = c("FIN","BIA","BCI")
for (site in sites){
  

for (i in 1:length(runs)){
 
  #for (site in c("FIN","BIA","BCI")){
  
  cveg_e <- get_output_LPJGUESS(site,run = runs[i],var = var,file.dir.lpjguess,co2_levels = "PS_562ppm")
  cveg_a <- get_output_LPJGUESS(site,run = runs[i],var = var,file.dir.lpjguess,co2_levels = "PS_412ppm")

  if(i==1){
    plot(cveg_e@data$Year,cveg_e@data$Total,lty=2, type="l",xlim=c(30,250),main=paste("LPJG",site), col =i,ylim=c(0,30))
    lines(cveg_a@data$Year,cveg_a@data$Total, col =i)
  }
  else{
    lines(cveg_e@data$Year,cveg_e@data$Total,lty=2, col =i)
    lines(cveg_a@data$Year,cveg_a@data$Total, col =i)
  }
    
}
}

plotTemporal(get_output_LPJGUESS(site="FIN",run = "P0",var = "cveg",file.dir.lpjguess,co2_levels = "PS_562ppm"))

for (i in 1:length(runs)){
 
  
  #for (site in c("FIN","BIA","BCI")){
  
  FATES_e <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_562ppm")
  FATES_a <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_412ppm")

  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total,lty=2, type="l",xlim=c(0,100),main="CABLE", col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
  else{
    lines(FATES_e@data$Year,FATES_e@data$Total,lty=2, col =i)
       lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
    
}


for (i in 1:length(runs)){
 
  #for (site in c("FIN","BIA","BCI")){
  
  FATES_e <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "562ppm")
  FATES_a <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total,lty=2, type="l",xlim=c(0,150),main="BiomeES", col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
  else{
    lines(FATES_e@data$Year,FATES_e@data$Total,lty=2, col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
    
}

for (i in 1:length(runs)){
 
  #for (site in c("FIN","BIA","BCI")){
  
  FATES_e <- get_output_BiomeEP(site,run = runs_biomeEP[i],var = var, file.dir.biomeEP,co2_levels = "562ppm")
  FATES_a <- get_output_BiomeEP(site,run = runs_biomeEP[i],var = var, file.dir.biomeEP,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total,lty=2, type="l",xlim=c(0,150),main="BiomeES", col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
  else{
    lines(FATES_e@data$Year,FATES_e@data$Total,lty=2, col =i)
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
    
}


for (i in 1:length(runs)){
 
  #for (site in c("FIN","BIA","BCI")){
  
  FATES_e <- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "562ppm")
  FATES_a <- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total,lty=2, type="l",xlim=c(0,150),main="JULES-RED", col =i,ylim=c(0,30))
    lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
  else{
    lines(FATES_e@data$Year,FATES_e@data$Total,lty=2, col =i)
       lines(FATES_a@data$Year,FATES_a@data$Total, col =i)
  }
    
}






########################################################################################
site="BCI"

for (i in 1:(length(runs)-1)){
 print(i)
  #for (site in c("FIN","BIA","BCI")){
  
    FATES_e <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")
  FATES_a <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "412ppm")


  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total-FATES_a@data$Total,lty=2, type="l",main="CABLE", col =i,ylim=c(0,16),lwd=2)
  }
  else{
    lines(FATES_e@data$Total-FATES_a@data$Total,lty=2, col =i,lwd=2)
       
  }
  
}

for (i in 1:(length(runs)-1)){
 print(i)
  #for (site in c("FIN","BIA","BCI")){
  
   FATES_e <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_562ppm")
  FATES_a <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_412ppm")


  if(i==1){
    plot(FATES_e@data$Year,FATES_e@data$Total/FATES_a@data$Total,lty=2, type="l",main="CABLE", col =i,ylim=c(0,4),lwd=2)
  }
  else{
    lines(FATES_e@data$Total/FATES_a@data$Total,lty=2, col =i,lwd=2)
       
  }
  
}


legend(legend=c(as.character(seq(1,6)),fill=c(1,2,3,4,5,6)),"topright")

#grid.arrange(pBiomeEP,pJULESRED,pFATES,pBiomeES,pLPJGUESS,pCABLEPOP)
}

# JULESRED and LPJGUESS need to start at higher cmass values. 
```


```{r residence_time, eval = FALSE}

# AGcwood/cmort
# reduction of residence time -> acceleration of mortality rate

#BIOME
  #for (site in c("FIN","BIA","BCI")){
  i=1
  FATES_eAGB<- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "562ppm")
  FATES_aAGB <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "AGB", file.dir.biomeE_Standalone,co2_levels = "412ppm")
  FATES_ecmort_size<- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "cmort_size", file.dir.biomeE_Standalone,co2_levels = "562ppm")
  FATES_acmort_size <- get_output_BiomeE_standalone(site,run = runs_biomeES[i],var = "cmort_size", file.dir.biomeE_Standalone,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_eAGB@data$Year,FATES_eAGB@data$Total/FATES_ecmort_size@data$Total,lty=2, type="l",main="BiomeES", col =i)
    lines(FATES_eAGB@data$Year,FATES_aAGB@data$Total/FATES_acmort_size@data$Total, col =i)
  }else{
    lines(FATES_eAGB@data$Year,FATES_eAGB@data$Total/FATES_ecmort_size@data$Total,lty=2, col =i)
    lines(FATES_eAGB@data$Year,FATES_aAGB@data$Total/FATES_acmort_size@data$Total, col =i)
  }
  
  
 mean(FATES_eAGB@data$Total[400:800]/FATES_ecmort_size@data$Total[400:800])
  mean(FATES_aAGB@data$Total[400:800]/FATES_acmort_size@data$Total[400:800])

    
  ###JULESRED
    #for (site in c("FIN","BIA","BCI")){
  i=1
  var="AGB"
  FATES_eAGB<- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "562ppm")
  FATES_aAGB <- get_output_JULESRED(site,run = runs_julesred[i],var = "AGB",file.dir.julesred,co2_levels = "412ppm")
  var="cmort"
  FATES_ecmort_size<-  get_output_JULESRED(site,run = runs_julesred[i],var = var,file.dir.julesred,co2_levels = "562ppm")
  FATES_acmort_size <- get_output_JULESRED(site,run = runs_julesred[i],var = var,file.dir.julesred,co2_levels = "412ppm")

  if(i==1){
    plot(FATES_eAGB@data$Year,FATES_eAGB@data$Total/FATES_ecmort_size@data$Total,lty=2, type="l",main="JULESRED", col =i,ylim=c(18,20))
    lines(FATES_eAGB@data$Year,FATES_aAGB@data$Total/FATES_acmort_size@data$Total, col =i)
  }else{
    lines(FATES_eAGB@data$Year,FATES_eAGB@data$Total/FATES_ecmort_size@data$Total,lty=2, col =i)
    lines(FATES_eAGB@data$Year,FATES_aAGB@data$Total/FATES_acmort_size@data$Total, col =i)
  }
  
  
#######
 # FATES
var="AGcwood"
i=1
  FATES_eAGB <-  get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")
  FATES_aAGB <-  get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "412ppm")
  
  var="cmort"
  FATES_ecmort_size<-  get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "562ppm")
  
  FATES_acmort_size <- get_output_FATES(site,run = runs[i],var = var,file.dir.fates,co2_levels = "412ppm")
  

    plot(FATES_eAGB@data$Year,FATES_eAGB@data$Total/FATES_ecmort_size@data$Total,lty=2, type="l",main="FATES", col =i)
    lines(FATES_aAGB@data$Year,FATES_aAGB@data$Total/FATES_acmort_size@data$Total, col =i)

mean(FATES_aAGB@data$Total[300:450]/FATES_acmort_size@data$Total[300:450])
mean(FATES_eAGB@data$Total[300:450]/FATES_ecmort_size@data$Total[300:450])

##############
 # CABLE POP
var="AGcwood"
i=1
  FATES_e <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_562ppm")
  FATES_a <- get_output_CABLEPOP(site,run = runs_cablepop[i],var = var,file.dir.cablepop,co2_levels = "PS_412ppm")
  
  var="cmort"
 CABLEPOP_ccrowd <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_crowd",file.dir.cablepop,co2_levels = "PS_562ppm")
 CABLEPOP_cdist <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_dist",file.dir.cablepop,co2_levels = "PS_562ppm")
 CABLEPOP_cres <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_res",file.dir.cablepop,co2_levels = "PS_562ppm")

 #create total mortality object for CABLEPOP:
 ecmort_size<- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_crowd",file.dir.cablepop,co2_levels = "PS_562ppm")
 ecmort_size@quant <- get_quantity("cmort")
 ecmort_size@quant@units <- "kgC m-2 yr-1"
 ecmort_size@id <- paste0(site,".cmort.Spatial_site.0-449.daily.none.of.annually")
 ecmort_size@data$Total <-CABLEPOP_ccrowd@data$Total +CABLEPOP_cdist@data$Total +CABLEPOP_cres@data$Total
  
 var="cmort"
 CABLEPOP_ccrowd <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_crowd",file.dir.cablepop,co2_levels = "PS_412ppm")
 CABLEPOP_cdist <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_dist",file.dir.cablepop,co2_levels = "PS_412ppm")
 CABLEPOP_cres <- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_res",file.dir.cablepop,co2_levels = "PS_412ppm")

 #create total mortality object for CABLEPOP:
 acmort_size<- get_output_CABLEPOP(site,run =  runs_cablepop[i],var = "cmort_crowd",file.dir.cablepop,co2_levels = "PS_412ppm")
 acmort_size@quant <- get_quantity("cmort")
 acmort_size@quant@units <- "kgC m-2 yr-1"
 acmort_size@id <- paste0(site,".cmort.Spatial_site.0-449.daily.none.of.annually")
 acmort_size@data$Total <-CABLEPOP_ccrowd@data$Total +CABLEPOP_cdist@data$Total +CABLEPOP_cres@data$Total

plot(FATES_eAGB@data$Year,FATES_eAGB@data$Total/ecmort_size@data$Total,lty=2, type="l",main="FATES", col =i)
lines(FATES_aAGB@data$Year,FATES_aAGB@data$Total/acmort_size@data$Total, col =i)

mean(FATES_aAGB@data$Total[300:449]/acmort_size@data$Total[300:449])
mean(FATES_eAGB@data$Total[300:449]/ecmort_size@data$Total[300:449])


```


